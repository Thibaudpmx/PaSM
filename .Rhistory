}
# rm filter pos
for(cmt in cmts){
filter_template <- self$make_filters(cmt)%>%
gsub(pattern = "line\\$", replacement = "")
# set pos abov
temp <-  self$filters_pos_above[[cmt]]
if(is.null(temp)) temp <- tibble()
filter_temp <- paste("(", filter_template[[1]], ")")
if(nrow(temp) > 0){
for(a in 1:nrow(temp)){
ref <-temp %>% slice(a)
poolVP %>%
filter(!!parse_expr(filter_temp)) %>%
pull(rowid) ->rowidstemp
poolVP[[paste0(cmt, "_AL")]][rowidstemp] <- rep(T, length(rowidstemp))
}
}
# set pos below
temp <-  self$filters_pos_below[[cmt]]
filter_temp <- paste("(", filter_template[[2]], ")")
if(is.null(temp)) temp <- tibble()
if(nrow(temp) > 0){
for(a in 1:nrow(temp)){
ref <-temp %>% slice(a)
poolVP %>%
filter(!!parse_expr(filter_temp)) %>%
pull(rowid) ->rowidstemp
poolVP[[paste0(cmt, "_BU")]][rowidstemp] <- T
}
}
}
if(time_compteur == T){
timesaver$filtre_prev <- tibble(time = difftime(Sys.time(), t0, units = "s"), nrem =nbef -  nrow(poolVP) )
}
if(nrow(self$poolVP) > 0 ) poolVP <- poolVP %>%
mutate(cellid = cellid + max(self$poolVP$cellid),
rowid = rowid + max(self$poolVP$rowid))
### eviter les loupes infinis si un protocole n'as pas d'observion (ex no PK for control PD group)..
if(time_compteur == T) t0 <- Sys.time()
crossing(protocols = unique(toadd$protocol), cmt =  self$targets %>%
filter(protocol %in% unique(poolVP$protocol)) %>%
pull(cmt) %>%
unique) %>%
full_join(self$targets) %>%
filter(is.na(time)) -> torem
if(time_compteur == T) timesaver$toremfilter <- difftime(Sys.time(),t0, units = "s")
if(nrow(torem)>0){
for(a in 1:nrow(torem)){
cmt_to_rm <- torem$cmt[[a]]
pro <- torem$protocol[[a]]
poolVP[[paste0(cmt_to_rm,"_BU")]][poolVP$protocol == pro] <- FALSE
poolVP[[paste0(cmt_to_rm,"_AL")]][poolVP$protocol == pro] <- FALSE
}
}
if(time_compteur == T) timesaver$toremfilter2 <- difftime(Sys.time(),t0, units = "s")
# Handling death and survival agents, to greatly accelerate the process
all_param <- self$param
filters <-  list()
for(a in unique(self$targets$cmt)){
filters[[a]] <- self$make_filters(cmt = a)   %>%
gsub(pattern = "line\\$", replacement = "" )
}
# line_compar <- paste0("which(", line_compar,")")
# saveRDS(object = poolVP, file = gsub("\\.RDS", "_todetermine.RDS", file))
# Time compteur
if(time_compteur == T){
timesaver$poolVP_compteur <- tibble(n = NA, time  = NA, nelim =NA, ninfo =NA_real_, computmodel = NA)
n_compteur <- 0
}
siml <- tibble(cellid = integer(), protocol = character())
# just in case we never enter into the loop (if already filled, almost always useless)
ntotal <- nrow(poolVP)
t00 <- Sys.time()
maxinfo <- is.na(poolVP[, col_to_add]) %>% sum
pb <- progress_bar$new(
format = "  VP creation [:bar] :current/:total (:percent) in :elapsed",
total = maxinfo, clear = FALSE, width= 60)
# pb <- progress_bar$new(total = )
slice0 <- poolVP   %>% slice(0) %>% select(!!!parse_exprs(all_param[all_param != "protocol"])) # filre_neg_above
neg_below <- neg_above <-  pos_below <- pos_above <- list() # filtre_neg_below
for(a in self$targets$cmt){
pos_below[[a]] <- slice0
pos_above[[a]] <- slice0
}
use_red_filter <- T
newratio <- is.na(poolVP[, col_to_add]) %>% sum
pb$update(ratio = (maxinfo -newratio )/maxinfo)
if(time_compteur == T){
n_compteur <- n_compteur + 1
poolVP_compteur_new <- timesaver$poolVP_compteur %>%
slice(1) %>%
mutate(n = n_compteur)
}
# Just compute some stat...
t0 <- Sys.time()
set.seed(89651)
# filter =  # which(is.na(poolVP[, col_to_add]) %>% apply(1, sum) != 0 )
filter_to_use <-  paste0("is.na(", col_to_add,")") %>%
paste0(collapse = "|")
line <- poolVP %>%
filter(!!parse_expr(filter_to_use))
line <- line %>%
filter(protocol == sample(line$protocol, 1))
line <- line %>%
sample_n(min(npersalve, nrow(line))) %>%
rowid_to_column("id")
if(time_compteur == T) poolVP_compteur_new$timesampleline <- difftime(Sys.time(), t0, units = "s")
# Now we need to handle the administrations
# by making a temporar copy
# protocol  <- self$protocols[[line$protocol[[1]]]]
if(time_compteur == T) t02 <- Sys.time()
protocol <-  line %>%
mutate(protocol2 = map(protocol, ~ self$protocols[[.x]])) %>%
select(id, protocol2) %>%
unnest(protocol2)
if(time_compteur == T) poolVP_compteur_new$protocoldf <- difftime(Sys.time(), t02, units = "s")
# add_events_line$amt[is.na(add_events_line$amt )] <- 0
# And now we can make the simulation and extract the result !
time_simulations <- Sys.time()
b <- Sys.time()
res <- simulations2(ind_param = line, add_events = protocol, returnSim = T,
icmt = self$initial_cmt_values, time_vec =self$times,
pardf = self$parameters_default_values, model = self$model)#;res
res <- as.tibble(res)
time_simulations <-  difftime(Sys.time(), b, units = "s")
n_simulations <-  nrow(line)
if(time_compteur == T){
poolVP_compteur_new$timemodel <- time_simulations
poolVP_compteur_new$nsimul <- n_simulations
}
# if(time_compteur == T) poolVP_compteur_new <- poolVP_compteur_new %>%
# mutate(computmodel = as.double(difftime(Sys.time(),b, units = "sec")))
remv <- F
cellidtorem <- double()
if(time_compteur == T) t02 <- Sys.time()
# # get targets for this patients
targets_temp <- self$targets %>%
filter(protocol == unique(line$protocol))#%>%
res2 <- res %>%
gather("cmt", "value", unique(targets_temp$cmt)) %>%
filter(time %in% targets_temp$time) %>%
left_join( targets_temp, by = c("time", "cmt")) %>%
filter(!is.na(min)) %>%
mutate(be_up = value <= max) %>%
mutate(ab_low = value >= min)
##### Remove patients neg  and compute red filters if activated ########
# lines output neg_ below
if(time_compteur == T) t02 <- Sys.time()
t0filternegbelow <- Sys.time()
res2 %>%
filter(ab_low == 0) %>%
group_by(id, cmt) %>%
slice(1) %>% ungroup() -> idsbelow
filters_neg_below <- idsbelow %>%
left_join(line,by = c("id", "protocol")) %>%
select(!!!parse_exprs(all_param), "cmt","cellid")
if(nrow(filters_neg_below) > 0){
filters_neg_below_up_reduc <- filter_reduc(filters_neg_below ,obj = self, direction = "below")
#%>%
# arrange(k2, desc(lambda0))
}else{
filters_neg_below_up_reduc <- filters_neg_below
}
if(time_compteur == T){
poolVP_compteur_new$filter_neg_below <- difftime(Sys.time(), t02, units = "s")
poolVP_compteur_new$nfilter_negbel_bef <- nrow(filters_neg_below)
poolVP_compteur_new$nfilters_negbel_af <- nrow(filters_neg_below_up_reduc)
}
timefilternegbelowmake <- difftime(Sys.time(),t0filternegbelow , units = "s")
# lines output neg_ above
if(time_compteur == T) t02 <- Sys.time()
line
line %>% filter(!!test2)
test2
test2 <- expr(k2 == 0.15 & lambda0 == 0.05)
line %>% filter(!!test2)
# lines output neg_ above
if(time_compteur == T) t02 <- Sys.time()
t0filternegabovemake <- Sys.time()
res2 %>%
filter(be_up == 0) %>%
group_by(id, cmt) %>%
slice(1) %>% ungroup() ->idsabove
filters_neg_above <-  idsabove %>%
left_join(line,by = c("id", "protocol")) %>%
select(!!!parse_exprs(all_param), "cmt" , "cellid")
if(nrow(filters_neg_above) > 0){
filters_neg_above_reduc <- filter_reduc(filters_neg_above ,obj = self, direction =  "above")
# %>%
# arrange(desc(k2))
}else{
filters_neg_above_reduc <- filters_neg_above
}
if(time_compteur == T){
poolVP_compteur_new$filter_neg_above <- difftime(Sys.time(), t02, units = "s")
poolVP_compteur_new$nfilter_negab_bef <- nrow(filters_neg_above)
poolVP_compteur_new$nfilters_negab_af <- nrow(filters_neg_above_reduc)
}
timefilternegabovemake <- difftime(Sys.time(),t0filternegabovemake , units = "s")
if(time_compteur == T) t02 <- Sys.time()
## We remove all the one not accepted
poolVP <- poolVP %>%
filter(! cellid %in% unique(filters_neg_above$cellid) & !  cellid %in% unique(filters_neg_below$cellid))
poolVP
poolVP %>% filter(!!test2)
t02 <- Sys.time()
nref <- nrow(poolVP)
if(time_compteur == T){
t02 <- t02
nref <- nref
}
filters_neg_above_reduc
a ) 1
ref <- filters_neg_above_reduc %>% slice(a)
a
a= 1
ref <- filters_neg_above_reduc %>% slice(a)
filters[[ref$cmt]][["above"]]
poolVP2 <- poolVP
if(nrow(filters_neg_above_reduc) > 0){
for(a in 1:nrow(filters_neg_above_reduc)){
ref <- filters_neg_above_reduc %>% slice(a)
poolVP <- poolVP %>%
mutate(test = !!parse_expr(filters[[ref$cmt]][["above"]])) %>%
filter(test == F)
}
}
poolVP %>% filter(!!test2)
if(nrow(filters_neg_below_up_reduc)> 0){
for(a in 1:nrow(filters_neg_below_up_reduc)){
ref <- filters_neg_below_up_reduc %>% slice(a)
poolVP <- poolVP %>%
mutate(test = !!parse_expr(filters[[ref$cmt]][["below"]])) %>%
filter(test == F)
}
}
poolVP %>% filter(!!test2)
poolVP <- poolVP2
poolVP %>% filter(!!test2)
filters_neg_below_up_reduc
filters[[ref$cmt]][["below"]]
filters_neg_below_up_reduc %>% filter(lambda0 >= 0.05 & k2 <= 0.15)
VP_df <- crossing(k1 = c(0.5),
k2 = seq(0,3,0.005),
ke = 1 ,#*  seq(0.6,1.4,0.2),
lambda0 =seq(0,1,0.005),
lambda1 = c(12),
Vd =  40) %>% #c(0.8,1,1.2)) %>%
map_df(function(x){
if(is.character(x)) return(x)
round(x,3)
} )
self$add_VP(VP_df, fillatend = F, reducefilteratend = F,  npersalve = 2000,  time_compteur = F,keepRefFiltaftDis = T)
self$plot_2D(k2, lambda0, plotoreturn = 1)+
geom_point(aes(x = 2.23, y = 0.65), col = "darkgreen") +
geom_point(aes(x = 0.15, y = 0.05)) +
guides(shape = F)+
# geom_point(data = VP_df, aes(k2, lambda0))
geom_point(data = self$poolVP, aes(x = k2, y = lambda0), col = "darkgreen")
self$filters_neg_below
self$filters_neg_below %>%
filter(k2 == 0)
self$filters_neg_below %>%
distinct(iddummy)
self$filters_neg_below %>%
distinct(iddummy) %>% tally
self$filters_neg_below %>%
distinct(iddummy) %>% pull(iddummy)
self$filters_neg_below %>% filter(lambda0 >= 0.05 & k2 <= 0.15)
i
#
# res <- simulations2(ind_param = line, add_events = protocol, returnSim = T,
#                     icmt = twozone$initial_cmt_values, time_vec =twozone$times,
#                     pardf = twozone$parameters_default_values, model = twozone$model) %>%
#   as_tibble()#;res
#
# res %>%
#   filter(time == 12 | time == 40) %>%
#   pull(tumVol)
## end determine the value
source("D:/these/Second_project/QSP/QSPVP/R/R6object.R")
prototiny <- tibble(protocol = "dose50", cmt = "tumVol", time = c(12,40), min = c(68.5523, 398.8405), max = c(68.55235, 398.8506))
self <- VP_proj_creator$new()
self$set_targets(filter = Dose==50 & cmt == "tumVol",timeforce = c(12,45))
self$targets <- prototiny
VP_df <- crossing(k1 = c(0.5),
k2 = seq(0,3,0.005),
ke = 1 ,#*  seq(0.6,1.4,0.2),
lambda0 =seq(0,1,0.005),
lambda1 = c(12),
Vd =  40) %>% #c(0.8,1,1.2)) %>%
map_df(function(x){
if(is.character(x)) return(x)
round(x,3)
} )
self$add_VP(VP_df, fillatend = F, reducefilteratend = F,  npersalve = 2000,  time_compteur = F,keepRefFiltaftDis = T)
umVol)
## end determine the value
source("D:/these/Second_project/QSP/QSPVP/R/R6object.R")
prototiny <- tibble(protocol = "dose50", cmt = "tumVol", time = c(12,40), min = c(68.5523, 398.8405), max = c(68.55235, 398.8506))
self <- VP_proj_creator$new()
self$set_targets(filter = Dose==50 & cmt == "tumVol",timeforce = c(12,45))
self$targets <- prototiny
VP_df <- crossing(k1 = c(0.5),
k2 = seq(0,3,0.005),
ke = 1 ,#*  seq(0.6,1.4,0.2),
lambda0 =seq(0,1,0.005),
lambda1 = c(12),
Vd =  40) %>% #c(0.8,1,1.2)) %>%
map_df(function(x){
if(is.character(x)) return(x)
round(x,3)
} )
self$add_VP(VP_df, fillatend = F, reducefilteratend = F,  npersalve = 2000,  time_compteur = F,keepRefFiltaftDis = T)
self$filters_neg_below
self$filters_neg_below %>%
filter(iddummy == 107)
self$plot_2D(k2, lambda0, plotoreturn = 1)+
geom_point(aes(x = 2.23, y = 0.65), col = "darkgreen") +
geom_point(aes(x = 0.15, y = 0.05)) +
guides(shape = F)+
# geom_point(data = VP_df, aes(k2, lambda0))
geom_point(data = self$poolVP, aes(x = k2, y = lambda0), col = "darkgreen")
#
# res <- simulations2(ind_param = line, add_events = protocol, returnSim = T,
#                     icmt = twozone$initial_cmt_values, time_vec =twozone$times,
#                     pardf = twozone$parameters_default_values, model = twozone$model) %>%
#   as_tibble()#;res
#
# res %>%
#   filter(time == 12 | time == 40) %>%
#   pull(tumVol)
## end determine the value
source("D:/these/Second_project/QSP/QSPVP/R/R6object.R")
prototiny <- tibble(protocol = "dose50", cmt = "tumVol", time = c(12,40), min = c(68.5523, 398.8405), max = c(68.55235, 398.8506))
self <- VP_proj_creator$new()
self$set_targets(filter = Dose==50 & cmt == "tumVol",timeforce = c(12,45))
self$targets <- prototiny
VP_df <- crossing(k1 = c(0.5),
k2 = seq(0,3,0.005),
ke = 1 ,#*  seq(0.6,1.4,0.2),
lambda0 =seq(0,1,0.005),
lambda1 = c(12),
Vd =  40) %>% #c(0.8,1,1.2)) %>%
map_df(function(x){
if(is.character(x)) return(x)
round(x,3)
} )
self$add_VP(VP_df, fillatend = F, reducefilteratend = F,  npersalve = 2000,  time_compteur = F,keepRefFiltaftDis = T)
self$plot_2D(k2, lambda0, plotoreturn = 1)+
geom_point(aes(x = 2.23, y = 0.65), col = "darkgreen") +
geom_point(aes(x = 0.15, y = 0.05)) +
guides(shape = F)+
# geom_point(data = VP_df, aes(k2, lambda0))
geom_point(data = self$poolVP, aes(x = k2, y = lambda0), col = "darkgreen")
VP_df
60* 0.35
# determine a tiny tiny target
# line <- tibble(k1 = 0.5,
#                  k2 = 2.23,
#                  ke = 1 ,#*  seq(0.6,1.4,0.2),
#                  lambda0 = 0.65,
#                  lambda1 = c(12),
#                  Vd =  40) %>%
#   rowid_to_column("id") %>%
#   mutate(protocol = "dose50")
#
#
# protocol <-  line %>%
#   mutate(protocol2 = map(protocol, ~ self$protocols[[.x]])) %>%
#   select(id, protocol2) %>%
#   unnest(protocol2)
#
# res <- simulations2(ind_param = line, add_events = protocol, returnSim = T,
#                     icmt = twozone$initial_cmt_values, time_vec =twozone$times,
#                     pardf = twozone$parameters_default_values, model = twozone$model) %>%
#   as_tibble()#;res
#
# res %>%
#   filter(time == 12 | time == 40) %>%
#   pull(tumVol)
## end determine the value
source("D:/these/Second_project/QSP/QSPVP/R/R6object.R")
prototiny <- tibble(protocol = "dose50", cmt = "tumVol", time = c(12,40), min = c(68.5523, 398.8405), max = c(68.55235, 398.8506))
self <- VP_proj_creator$new()
self$set_targets(filter = Dose==50 & cmt == "tumVol",timeforce = c(12,45))
self$targets <- prototiny
VP_df <- crossing(k1 = c(0.5),
k2 = seq(0,3,0.005),
ke = 1 ,#*  seq(0.6,1.4,0.2),
lambda0 =seq(0,1,0.005),
lambda1 = c(12),
Vd =  40) %>% #c(0.8,1,1.2)) %>%
map_df(function(x){
if(is.character(x)) return(x)
round(x,3)
} )
self$add_VP(VP_df, fillatend = F, reducefilteratend = F,  npersalve = 2000,  time_compteur = F,keepRefFiltaftDis = T)
self$plot_2D(k2, lambda0, plotoreturn = 1)+
geom_point(aes(x = 2.23, y = 0.65), col = "darkgreen") +
geom_point(aes(x = 0.15, y = 0.05)) +
guides(shape = F)+
# geom_point(data = VP_df, aes(k2, lambda0))
geom_point(data = self$poolVP, aes(x = k2, y = lambda0), col = "darkgreen")
self$n_filter_reduc()
self$plot_2D(k2, lambda0, plotoreturn = 1)+
geom_point(aes(x = 2.23, y = 0.65), col = "darkgreen") +
geom_point(aes(x = 0.15, y = 0.05)) +
guides(shape = F)+
# geom_point(data = VP_df, aes(k2, lambda0))
geom_point(data = self$poolVP, aes(x = k2, y = lambda0), col = "darkgreen")
pull(tumVol)
## end determine the value
source("D:/these/Second_project/QSP/QSPVP/R/R6object.R")
prototiny <- tibble(protocol = "dose50", cmt = "tumVol", time = c(12,40), min = c(68.5523, 398.8405), max = c(68.55235, 398.8506))
self <- VP_proj_creator$new()
self$set_targets(filter = Dose==50 & cmt == "tumVol",timeforce = c(12,45))
self$targets <- prototiny
VP_df <- crossing(k1 = c(0.5),
k2 = seq(0,3,0.005),
ke = 1 ,#*  seq(0.6,1.4,0.2),
lambda0 =seq(0,1,0.005),
lambda1 = c(12),
Vd =  40) %>% #c(0.8,1,1.2)) %>%
map_df(function(x){
if(is.character(x)) return(x)
round(x,3)
} )
self$add_VP(VP_df, fillatend = F, reducefilteratend = F,  npersalve = 2000,  time_compteur = F,keepRefFiltaftDis = T)
self$plot_2D(k2, lambda0, plotoreturn = 1)+
geom_point(aes(x = 2.23, y = 0.65), col = "darkgreen") +
geom_point(aes(x = 0.15, y = 0.05)) +
guides(shape = F)+
# geom_point(data = VP_df, aes(k2, lambda0))
geom_point(data = self$poolVP, aes(x = k2, y = lambda0), col = "darkgreen")
self$n_filter_reduc()
self$plot_2D(k2, lambda0, plotoreturn = 1)+
geom_point(aes(x = 2.23, y = 0.65), col = "darkgreen") +
geom_point(aes(x = 0.15, y = 0.05)) +
guides(shape = F)+
# geom_point(data = VP_df, aes(k2, lambda0))
geom_point(data = self$poolVP, aes(x = k2, y = lambda0), col = "darkgreen")
self$plot_2D(k2, lambda0, plotoreturn = 1)+
geom_point(aes(x = 2.23, y = 0.65), col = "darkgreen") +
geom_point(aes(x = 0.15, y = 0.05)) +
guides(shape = F)+
# geom_point(data = VP_df, aes(k2, lambda0))
geom_point(data = self$poolVP, aes(x = k2, y = lambda0), col = "darkgreen")+
geom_hline(yintercept = unique(VP_df$lambda0))
# end determine the value
source("D:/these/Second_project/QSP/QSPVP/R/R6object.R")
prototiny <- tibble(protocol = "dose50", cmt = "tumVol", time = c(12,40), min = c(68.5523, 398.8405), max = c(68.55235, 398.8506))
self <- VP_proj_creator$new()
self$set_targets(filter = Dose==50 & cmt == "tumVol",timeforce = c(12,45))
self$targets <- prototiny
VP_df <- crossing(k1 = c(0.5),
k2 = seq(0,3,0.05),
ke = 1 ,#*  seq(0.6,1.4,0.2),
lambda0 =seq(0,1,0.05),
lambda1 = c(12),
Vd =  40) %>% #c(0.8,1,1.2)) %>%
map_df(function(x){
if(is.character(x)) return(x)
round(x,3)
} )
VP_df
self$add_VP(VP_df, fillatend = F, reducefilteratend = F,  npersalve = 2000,  time_compteur = F,keepRefFiltaftDis = T)
self$plot_2D(k2, lambda0, plotoreturn = 1)+
geom_point(aes(x = 2.23, y = 0.65), col = "darkgreen") +
geom_point(aes(x = 0.15, y = 0.05)) +
guides(shape = F)+
# geom_point(data = VP_df, aes(k2, lambda0))
geom_point(data = self$poolVP, aes(x = k2, y = lambda0), col = "darkgreen")+
geom_hline(yintercept = unique(VP_df$lambda0))
pull(tumVol)
## end determine the value
source("D:/these/Second_project/QSP/QSPVP/R/R6object.R")
prototiny <- tibble(protocol = "dose50", cmt = "tumVol", time = c(12,40), min = c(68.5523, 398.8405), max = c(68.55235, 398.8506))
self <- VP_proj_creator$new()
self$set_targets(filter = Dose==50 & cmt == "tumVol",timeforce = c(12,45))
self$targets <- prototiny
# VP_df <- crossing(k1 = c(0.5),
#                           k2 = seq(0,3,0.005),
#                           ke = 1 ,#*  seq(0.6,1.4,0.2),
#                           lambda0 =seq(0,1,0.005),
#                           lambda1 = c(12),
#                           Vd =  40) %>% #c(0.8,1,1.2)) %>%
#   map_df(function(x){
#
#     if(is.character(x)) return(x)
#     round(x,3)
#
#   } )
VP_df <- crossing(k1 = c(0.5),
k2 = seq(0,3,0.05),
ke = 1 ,#*  seq(0.6,1.4,0.2),
lambda0 =seq(0,1,0.05),
lambda1 = c(12),
Vd =  40) %>% #c(0.8,1,1.2)) %>%
map_df(function(x){
if(is.character(x)) return(x)
round(x,3)
} )
self$add_VP(VP_df, fillatend = F, reducefilteratend = F,  npersalve = 2000,  time_compteur = F,keepRefFiltaftDis = T)
self$plot_2D(k2, lambda0, plotoreturn = 1)+
geom_point(aes(x = 2.23, y = 0.65), col = "darkgreen") +
geom_point(aes(x = 0.15, y = 0.05)) +
guides(shape = F)+
# geom_point(data = VP_df, aes(k2, lambda0))
geom_point(data = self$poolVP, aes(x = k2, y = lambda0), col = "darkgreen")+
geom_hline(yintercept = unique(VP_df$lambda0))
